---
title: "RNAseq_counts"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown


REVIEW THIS: http://bioconductor.org/packages/devel/bioc/vignettes/DESeq2/inst/doc/DESeq2.html#differential-expression-analysis


This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars, include=FALSE}




```

## Including Plots

You can also embed plots, for example:

```{r pressure, include=FALSE}
library(dplyr)
library(tidyverse)
library(data.table)
library(DESeq2)
library(Glimma)
library(biomaRt)

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.



```{r load counts}


countPATH <- "/bigdata/faustmanlab/bch/testis_coculture_baseline/aligned/count_files"

files <- list.files(path=countPATH, pattern="*.tab", full.names=TRUE)
names(files) <- lapply(strsplit(files, "/"), "[",8)
countslist <- lapply(files, read.delim, sep="\t", header=FALSE)
names(countslist)<- names(files)
colnames<- c("gene", "unstranded_counts", "Fstreadalign","Sndreadalign")


```


```{r rename}

# check that this is proper column


for (i in seq_along(countslist)){
  colnames(countslist[[i]]) <- colnames}

counts_temp <- lapply(countslist, function(x) {x <- x %>% dplyr::select(-c(Fstreadalign,Sndreadalign))})
counts_use <- lapply(counts_temp, function(x) {x <- x[-c(1:4),]})
all_counts <- plyr::join_all(counts_use, by = "gene")
colnames(all_counts)<-c("gene", names(counts_use))

rownames(all_counts)<- all_counts$gene
all_counts <- all_counts[,-1]



head(all_counts)

```
```{r metadata}

metadata <- data.table(

  sampleID=colnames(all_counts),
  samplename=paste0(sapply(strsplit(colnames(all_counts),"_"), `[`, 1),sapply(strsplit(colnames(all_counts),"_"), `[`, 2), sapply(strsplit(colnames(all_counts),"_"), `[`, 3)),
  date=sapply(strsplit(colnames(all_counts),"_"), `[`, 3),
  dish=sapply(strsplit(colnames(all_counts),"_"), `[`, 1),
  well=sapply(strsplit(colnames(all_counts),"_"), `[`, 2)
  
)

metadata$date[c(1:3)] <- "prep"

```

```{r deseq2}

dds <- DESeqDataSetFromMatrix(countData=all_counts,
                                colData = metadata,
                                 design = ~date)

dds <- DESeq(dds)
```
```{r min-counts}

keep <- rowSums(counts(dds) >= 5) >= 3
table(keep)



```
```{r filt genes}

dds <- dds[keep,]


```


```{r boxplot}

dds <- estimateSizeFactors(dds)
boxplot(log10(counts(dds,normalized=TRUE)+1))
```



```{r deseq2 workup}

res <- results(dds)
head(results(dds))
summary(res)

```

```{r pca}

vsdata <- vst(dds, blind=FALSE)
plotPCA(vsdata, intgroup="date")

```
```{r glimma}



glimmaMDS(dds)


```



```{r glimma ma}


head(res[order(res$pvalue),])
```
```{r plotMA}

plotMA(res, ylim=c(-5,5))

resultsNames(dds)
```




```{r results table}



day7_day3 <- as.data.frame(results(dds, name="date_Day7_vs_Day3", test="Wald"))

head(day7_day3[order(day7_day3$pvalue),])

day7_day3$geneID <- rownames(day7_day3)


```



```{r biomart}


mart <- useDataset("rnorvegicus_gene_ensembl", useMart("ensembl"))
genes <- rownames(day7_day3)

G_list <- getBM(filters= "ensembl_gene_id", attributes=c("ensembl_gene_id","rgd_symbol"),values=genes,mart= mart)
day7_day3 <- merge(day7_day3,G_list,by.x="geneID",by.y="ensembl_gene_id")


head(day7_day3[order(day7_day3$pvalue),])

```
```{r prep-day3}

day3_day0 <- as.data.frame(results(dds, name="date_prep_vs_Day3", test="Wald"))

day3_day0$geneID <- rownames(day3_day0)

mart <- useDataset("rnorvegicus_gene_ensembl", useMart("ensembl"))
genes <- rownames(day3_day0)

G_list_2 <- getBM(filters= "ensembl_gene_id", attributes=c("ensembl_gene_id","rgd_symbol"),values=genes,mart= mart)
day3_day0 <- merge(day3_day0,G_list_2,by.x="geneID",by.y="ensembl_gene_id")


head(day3_day0[order(day3_day0$pvalue),])

```

```{r prep-day5}

day3_day0 <- as.data.frame(results(dds, name="date_prep_vs_Day3", test="Wald"))

day3_day0$geneID <- rownames(day3_day0)

mart <- useDataset("rnorvegicus_gene_ensembl", useMart("ensembl"))
genes <- rownames(day3_day0)

G_list_2 <- getBM(filters= "ensembl_gene_id", attributes=c("ensembl_gene_id","rgd_symbol"),values=genes,mart= mart)
day3_day0 <- merge(day3_day0,G_list_2,by.x="geneID",by.y="ensembl_gene_id")


head(day3_day0[order(day3_day0$pvalue),])
```

```{r prep-day7}

day3_day0 <- as.data.frame(results(dds, name="date_prep_vs_Day3", test="Wald"))

day3_day0$geneID <- rownames(day3_day0)

mart <- useDataset("rnorvegicus_gene_ensembl", useMart("ensembl"))
genes <- rownames(day3_day0)

G_list_2 <- getBM(filters= "ensembl_gene_id", attributes=c("ensembl_gene_id","rgd_symbol"),values=genes,mart= mart)
day3_day0 <- merge(day3_day0,G_list_2,by.x="geneID",by.y="ensembl_gene_id")


head(day3_day0[order(day3_day0$pvalue),])

```

